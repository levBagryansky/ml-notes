# 3.**–ú–µ—Ç–æ–¥ back propagation**. –ö–∞–∫ —É—Å—Ç—Ä–æ–µ–Ω—ã, –∫–∞–∫–∞—è –≤—ã—á–∏—Å–ª–∏—Ç–µ–ª—å–Ω–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å –∏ —Å–ª–æ–∂–Ω–æ—Å—Ç—å –ø–æ –ø–∞–º—è—Ç–∏. Activation checkpointing. –û–±—É—á–µ–Ω–∏–µ –≤ —É—Å–ª–æ–≤–∏—è—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–π –ø–∞–º—è—Ç–∏.

–Ø–Ω–¥–µ–∫—Å https://education.yandex.ru/handbook/ml/article/metod-obratnogo-rasprostraneniya-oshibki
–°–µ–º–∏–Ω–∞—Ä https://education.yandex.ru/handbook/ml/article/metod-obratnogo-rasprostraneniya-oshibki
 
 –ò–∑ —Å–µ–º–∏–Ω–∞—Ä–∞:
 ùëì –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∞ –≤ –≤–∏–¥–µ –≤—ã—á–∏—Å–ª–∏—Ç–µ–ª—å–Ω–æ–≥–æ –≥—Ä–∞—Ñ–∞, –∫–∞–∂–¥—ã–π —É–∑–µ–ª –∫–æ—Ç–æ—Ä–æ–≥–æ –æ–±–æ–∑–Ω–∞—á–∞–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏—é –Ω–∞–¥ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π, —Ç–æ –µ—Å—Ç—å, –æ–ø–µ—Ä–∞—Ü–∏—é –Ω–∞–¥ –∫–∞–∫–∏–º-—Ç–æ —á–∏—Å–ª–æ–º, –≤–µ–∫—Ç–æ—Ä–æ–º, –º–∞—Ç—Ä–∏—Ü–µ–π –∏–ª–∏ —Ç–µ–Ω–∑–æ—Ä–æ–º.
 –ü—Ä–∏–º–µ—Ä –≥—Ä–∞—Ñ–∞
 ![–£–∑–µ–ª](image-2.png)
 ![–ì—Ä–∞—Ñ](image-1.png) 
## –¢—Ä–∏ —Å–ø–æ—Å–æ–±–∞: forward prop, back prop –∏ numeric.
![Forward prop](image-3.png)
![Comparing table](image-4.png)



# Activation Checkpointing

**Activation checkpointing** ‚Äî —ç—Ç–æ **—Ç–µ—Ö–Ω–∏–∫–∞ —É–º–µ–Ω—å—à–µ–Ω–∏—è –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è –ø–∞–º—è—Ç–∏** –ø—Ä–∏ –æ–±—É—á–µ–Ω–∏–∏ –Ω–µ–π—Ä–æ–Ω–Ω—ã—Ö —Å–µ—Ç–µ–π, –æ—Å–æ–±–µ–Ω–Ω–æ **–≥–ª—É–±–æ–∫–∏—Ö**.

---

## üß† –ü—Ä–æ–±–ª–µ–º–∞:

–í–æ –≤—Ä–µ–º—è **–æ–±—Ä–∞—Ç–Ω–æ–≥–æ –ø—Ä–æ—Ö–æ–¥–∞ (backpropagation)** –Ω—É–∂–Ω–æ:
- –≤—ã—á–∏—Å–ª–∏—Ç—å –≥—Ä–∞–¥–∏–µ–Ω—Ç—ã,
- –¥–ª—è —ç—Ç–æ–≥–æ ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **–∑–Ω–∞—á–µ–Ω–∏—è –∞–∫—Ç–∏–≤–∞—Ü–∏–π**, –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –Ω–∞ –ø—Ä—è–º–æ–º –ø—Ä–æ—Ö–æ–¥–µ (forward pass),
- –Ω–æ –µ—Å–ª–∏ —Å–µ—Ç—å –æ—á–µ–Ω—å –≥–ª—É–±–æ–∫–∞—è, —Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–∞—Ü–∏–π (–Ω–∞ –∫–∞–∂–¥–æ–º —Å–ª–æ–µ) —Ç—Ä–µ–±—É–µ—Ç **–º–Ω–æ–≥–æ –ø–∞–º—è—Ç–∏** ‚Äî —ç—Ç–æ **—É–∑–∫–æ–µ –º–µ—Å—Ç–æ –ø—Ä–∏ –æ–±—É—á–µ–Ω–∏–∏ –Ω–∞ GPU**.

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ: **Activation Checkpointing**

–ò–¥–µ—è –ø—Ä–æ—Å—Ç–∞—è:

> **–°–æ—Ö—Ä–∞–Ω—è—Ç—å –Ω–µ –≤—Å–µ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏, –∞ —Ç–æ–ª—å–∫–æ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ —Ç–æ—á–∫–∏ (checkpoints), –∞ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—Ç—å "–Ω–∞ –ª–µ—Ç—É" –≤–æ –≤—Ä–µ–º—è backpropagation.**

---

## üìâ –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ:

1. –í–æ –≤—Ä–µ–º—è **forward pass**:
   - —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ **–Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏** (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–∞–∂–¥—ã–µ 5 —Å–ª–æ—ë–≤),
   - –æ—Å—Ç–∞–ª—å–Ω—ã–µ **–Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è** ‚Äî –∑–Ω–∞—á–∏—Ç, –º–µ–Ω—å—à–µ –ø–∞–º—è—Ç–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è.

2. –í–æ –≤—Ä–µ–º—è **backward pass**:
   - –µ—Å–ª–∏ –Ω—É–∂–Ω–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è **–Ω–µ –±—ã–ª–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞**, –æ–Ω–∞ **–ø–µ—Ä–µ–≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è** –Ω–∞—á–∏–Ω–∞—è —Å –±–ª–∏–∂–∞–π—à–µ–π —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–π "–∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–π —Ç–æ—á–∫–∏".

---

## üîÅ –ö–æ–º–ø—Ä–æ–º–∏—Å—Å:

| –†–µ—Å—É—Ä—Å      | –û–±—ã—á–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ | –° checkpointing |
|-------------|------------------|-----------------|
| üíæ –ü–∞–º—è—Ç—å   | –≤—ã—Å–æ–∫–∞—è          | –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –Ω–∏–∂–µ |
| ‚è±Ô∏è –í—Ä–µ–º—è    | –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ      | –≤—ã—à–µ (–∏–∑-–∑–∞ –ø–µ—Ä–µ—Å—á—ë—Ç–∞) |

–¢—ã —ç–∫–æ–Ω–æ–º–∏—à—å –ø–∞–º—è—Ç—å **–≤ –æ–±–º–µ–Ω –Ω–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –≤—Ä–µ–º—è**.

---

## üì¶ –ì–¥–µ —ç—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è?

- –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–µ—Ä—ã (GPT, BERT –∏ –¥—Ä.), –∫–æ–≥–¥–∞ –º–æ–¥–µ–ª—å **—Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∞—è**.
- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏: PyTorch, TensorFlow –∏ –¥—Ä. –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç activation checkpointing –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ:
  ```python
  from torch.utils.checkpoint import checkpoint

  def forward_fn(x):
      return model_block(x)

  output = checkpoint(forward_fn, input)
  ```

---

## üß™ –ü—Ä–∏–º–µ—Ä:

–ï—Å–ª–∏ —É —Ç–µ–±—è —Å–µ—Ç—å –∏–∑ 100 —Å–ª–æ—ë–≤, –º–æ–∂–Ω–æ:
- —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —Ç–æ–ª—å–∫–æ –Ω–∞ —Å–ª–æ—è—Ö 0, 20, 40, 60, 80, 100;
- –ø—Ä–∏ backpropagation –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –º–µ–∂–¥—É –Ω–∏–º–∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.

---

## ‚úçÔ∏è TL;DR:

> **Activation checkpointing** ‚Äî —ç—Ç–æ –º–µ—Ç–æ–¥ —É–º–µ–Ω—å—à–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è GPU-–ø–∞–º—è—Ç–∏ –≤–æ –≤—Ä–µ–º—è –æ–±—É—á–µ–Ω–∏—è –Ω–µ–π—Ä–æ—Å–µ—Ç–∏ –∑–∞ —Å—á—ë—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ —á–∞—Å—Ç–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–π –∏ –∏—Ö –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –ø—Ä–∏ –æ–±—Ä–∞—Ç–Ω–æ–º –ø—Ä–æ—Ö–æ–¥–µ. –≠–∫–æ–Ω–æ–º–∏—Ç –ø–∞–º—è—Ç—å, –Ω–æ –∑–∞–º–µ–¥–ª—è–µ—Ç –æ–±—É—á–µ–Ω–∏–µ.
